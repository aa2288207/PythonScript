
import time
import requests
from bs4 import BeautifulSoup


headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.97 Safari/537.36",
    "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
    "accept-encoding": "gzip, deflate, sdch",
    "accept-language": "zh-CN,zh;q=0.8",
    "Referer": "https://www.exploit-db.com/"
}

sql_text = "update s_exploit set cve_id = '%s' where edb_id = %s;\n"
url_text = 'https://www.exploit-db.com/exploits/%s/'

dir_root = 'F:\\works\\cve\\edb-6\\'

filet = open('%sright_cve.txt' % dir_root, 'w')
log = open('%sright_log.txt' % dir_root, 'w')

with open('%sright_edb.txt' % dir_root, 'r') as f:
    try:
        for exploit_id in f.readlines():
            try:
                exploit_id = exploit_id.replace('\n', '')
                print(exploit_id)
                url = url_text % exploit_id
                r = requests.get(url, headers=headers, timeout=10)
                soup = BeautifulSoup(r.text, "html.parser")

                cve_id = 'N/A'
                for link in soup.find_all('a'):
                    href = link.get('href')
                    if href.find('?name=') != -1 and href.find('CVE-') != -1:
                        cve_id = href[href.find('?name=')+6:]
                        break

                sql = sql_text % (cve_id, exploit_id)
                filet.write(sql)
                time.sleep(1)
            except requests.ConnectionError:
                log.write('[%s] ConnectionError\n' % exploit_id)
            except requests.HTTPError:
                log.write('[%s] HTTPError\n' % exploit_id)
            except requests.Timeout:
                log.write('[%s] Timeout\n' % exploit_id)
            except requests.Timeout:
                log.write('[%s] TooManyRedirects\n' % exploit_id)
            except Exception as e:
                log.write('[%s] Exception: %s\n' % (exploit_id, e))

    finally:
        filet.close()
        log.close()
